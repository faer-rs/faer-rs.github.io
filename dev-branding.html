<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>lifetime-branded shapes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/sarah-quinones/faer-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lifetime-branding"><a class="header" href="#lifetime-branding">lifetime branding</a></h1>
<p>the typical way rust code deals with avoiding runtime bound checks is by using iterators.</p>
<p>this works less well in the case of linear algebra code because the 2d structure sometimes gives us
extra information to work with. and in the case of sparse algorithms, we have to deal with unstructured indices that we
don't necessarily want to repeatedly check.</p>
<p>to work around these limitations, faer primarily uses a technique called lifetime branding.
it revolves around defining unique types distinguished by their lifetimes.</p>
<p>types that differ only in their lifetimes are merged before code generation, so they help
keep the binary size small and allow some unique patterns.</p>
<p>the main example is the <code>Dim&lt;'N&gt;</code> type. it represents a matrix dimension that's fixed at runtime.
the invariant it carries is that for a given lifetime <code>'N</code>, two instances of this type
always have the same value. you can think of it as being similar to const generics (e.g. <code>Dim&lt;const N: usize&gt;</code>),
with the difference being that the size is fixed at runtime instead of comptime.
since <code>Dim&lt;'N&gt;</code> is defined to be invariant in the lifetime <code>'N</code>, this guarantees that
the borrow checker will never coerce an instance of <code>Dim&lt;'a&gt;</code> to <code>Dim&lt;'b&gt;</code>, unless <code>'a</code> and <code>'b</code>
match exactly.</p>
<p>instances of <code>Dim</code> along with their lifetimes can be created with the <code>with_dim!</code> macro.</p>
<p>other types are built around <code>Dim&lt;'N&gt;</code>'s invariant. for example <code>Idx&lt;'N&gt;</code> guarantees
that instances of it will always hold a valid index for the corresponding <code>Dim&lt;'N&gt;</code>,
which in turn implies that bound checks can be soundly elided.</p>
<p><code>MaybeIdx&lt;'N&gt;</code> carries either a valid index or a sentinel value, and <code>IdxInc&lt;'N&gt;</code> carries
an inclusive index, i.e. <code>idx &lt;= n</code>, and is often used for slicing matrices rather than indexing directly.</p>
<pre><code class="language-rust">with_dim!(N, 4);

let i = N.idx(3); // checks the index at creation

// ...

// compiles to a no-op, since the check is enforced at compile time thanks to the lifetime brand.
assert!(i &lt; N);</code></pre>
<h1 id="experimental-covariantcontravariant-lifetime-brands"><a class="header" href="#experimental-covariantcontravariant-lifetime-brands">experimental: covariant/contravariant lifetime brands</a></h1>
<p><em><code>faer</code></em> also has a mostly internal api that makes use of lifetime coercion to unlock new patterns.</p>
<p>the main idea is to generate lifetimes ordered by the <code>outlives</code> relationship that carry new invariants with them.</p>
<p>the main example is <code>Segment&lt;'scope, 'dim, 'range&gt;</code>, which is invariant over all three lifetimes and similarly enforces that instances of the same type hold the same value.
it also guarantees that for a fixed <code>'scope</code>, instances of the type hold a valid range that can be used to slice dimensions of <code>Dim&lt;'n&gt;</code>.</p>
<p>on top of that, given two lifetimes <code>'long_range</code> and <code>'short_range</code> such that <code>'long_range: 'short_range</code> (long outlives short),
<code>Segment</code> guarantees that instances of <code>Segment&lt;'scope, 'dim, 'short_range&gt;</code> carry a segment that's included in that of instances of <code>Segment&lt;'scope, 'dim, 'long_range&gt;</code>.</p>
<p>this fact is used by <code>SegmentIdx&lt;'scope, 'dim, 'range&gt;</code> and <code>SegmentIdxInc&lt;'scope, 'dim, 'range&gt;</code>, which are contravariant over the lifetime <code>'range</code>, and invariant over  the others.
this allows instances of <code>SegmentIdx&lt;'scope, 'dim, 'short_range&gt;</code> to be coerced to instances of <code>SegmentIdx&lt;'scope, 'dim, 'long_range&gt;</code>.</p>
<p>instances of <code>Segment</code> along with their lifetimes can be created with the <code>ghost_tree!</code> macro, which is more complex than <code>Dim</code>, since it needs to express the subset relationships between the different lifetimes.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="dev-layout.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="dev-simd.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="dev-layout.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="dev-simd.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
